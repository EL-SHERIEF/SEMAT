name: Export Framer Sites to HTML

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 */8 * * *'  # Runs every 8 hours
  workflow_dispatch:  # Allows manual triggering

jobs:
  export-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install HTTrack and Dependencies
        run: sudo apt-get update && sudo apt-get install -y httrack python3 curl

      - name: Export Arabic Framer Site (Main Site)
        run: |
          echo "Downloading Arabic site..."
          httrack "https://semat.framer.website/ar" -O ./main_site --mirror --keep-alive --depth=2 --clean -%v
          if [ -d "./main_site/semat.framer.website/ar" ]; then
            rsync -a ./main_site/semat.framer.website/ar/ ./
          else
            echo "Arabic site export failed" >&2
            exit 1
          fi
          rm -rf ./main_site

      - name: Export English Framer Site
        run: |
          echo "Downloading English site..."
          httrack "https://semat.framer.website/" -O ./en_site --mirror --keep-alive --depth=2 --clean -%v
          mkdir -p ./en
          if [ -d "./en_site/semat.framer.website" ]; then
            rsync -a --exclude 'ar' ./en_site/semat.framer.website/ ./en/
          else
            echo "English site export failed" >&2
            exit 1
          fi
          rm -rf ./en_site

      - name: Generate Sitemaps, Robots, and RSS
        run: |
          # Random offset for lastmod (0-60 minutes ago)
          RANDOM_OFFSET=$((RANDOM % 60))

          # Sitemap for root (Arabic)
          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml
          find . -type f -name "*.html" -not -path "./en/*" | while read -r file; do
            url="https://semat.agency/${file#./}"
            lastmod=$(date -u -d "$RANDOM_OFFSET minutes ago" +%Y-%m-%dT%H:%M:%SZ)
            priority=$(if [[ "$file" == "./index.html" ]]; then echo "1.0"; else echo "0.8"; fi)
            echo "  <url><loc>$url</loc><lastmod>$lastmod</lastmod><changefreq>daily</changefreq><priority>$priority</priority></url>" >> sitemap.xml
          done
          echo '</urlset>' >> sitemap.xml

          # Sitemap for /en (English)
          echo '<?xml version="1.0" encoding="UTF-8"?>' > en/sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> en/sitemap.xml
          find ./en -type f -name "*.html" | while read -r file; do
            url="https://semat.agency/${file#./}"
            lastmod=$(date -u -d "$RANDOM_OFFSET minutes ago" +%Y-%m-%dT%H:%M:%SZ)
            priority=$(if [[ "$file" == "./en/index.html" ]]; then echo "1.0"; else echo "0.8"; fi)
            echo "  <url><loc>$url</loc><lastmod>$lastmod</lastmod><changefreq>daily</changefreq><priority>$priority</priority></url>" >> en/sitemap.xml
          done
          echo '</urlset>' >> en/sitemap.xml

          # Robots.txt (SEO optimized, no crawl-me)
          echo "User-agent: *" > robots.txt
          echo "Allow: /" >> robots.txt
          echo "Allow: /en/" >> robots.txt
          echo "Disallow: /*?*" >> robots.txt
          echo "Disallow: /index.html" >> robots.txt
          echo "Sitemap: https://semat.agency/sitemap.xml" >> robots.txt
          echo "Sitemap: https://semat.agency/en/sitemap.xml" >> robots.txt
          echo "" >> robots.txt
          echo "Crawl-delay: 10" >> robots.txt

          # Verify robots.txt generation
          if [ -f robots.txt ]; then
            echo "robots.txt generated successfully:"
            cat robots.txt
          else
            echo "Failed to generate robots.txt" >&2
            exit 1
          fi

          # RSS feed
          echo '<?xml version="1.0" encoding="UTF-8"?>' > rss.xml
          echo '<rss version="2.0"><channel>' >> rss.xml
          echo "<title>Semat Agency Updates</title><link>https://semat.agency</link><description>Latest updates from Semat Agency</description>" >> rss.xml
          find . -type f -name "*.html" -not -path "./en/*" | while read -r file; do
            url="https://semat.agency/${file#./}"
            title=$(basename "$file" .html | tr '-' ' ' | awk '{for(i=1;i<=NF;i++){$i=toupper(substr($i,1,1)) substr($i,2)}}1')
            echo "<item><title>Arabic: $title</title><link>$url</link><pubDate>$(date -u -R)</pubDate><description>Updated Arabic page</description></item>" >> rss.xml
          done
          find ./en -type f -name "*.html" | while read -r file; do
            url="https://semat.agency/${file#./}"
            title=$(basename "$file" .html | tr '-' ' ' | awk '{for(i=1;i<=NF;i++){$i=toupper(substr($i,1,1)) substr($i,2)}}1')
            echo "<item><title>English: $title</title><link>$url</link><pubDate>$(date -u -R)</pubDate><description>Updated English page</description></item>" >> rss.xml
          done
          echo '</channel></rss>' >> rss.xml

      - name: Commit and Push Changes
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Automated update with SEO fixes (removed crawl-me)"
            git push https://x-access-token:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}.git HEAD:main
          fi

      - name: Verify Robots.txt Accessibility
        run: |
          echo "Verifying robots.txt accessibility..."
          sleep 10  # Adjust based on deployment time
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://semat.agency/robots.txt)
          if [ "$STATUS" -eq 200 ]; then
            echo "robots.txt is accessible at https://semat.agency/robots.txt (HTTP $STATUS)"
            curl -s https://semat.agency/robots.txt
          else
            echo "Failed to access robots.txt (HTTP $STATUS)" >&2
            exit 1
          fi
